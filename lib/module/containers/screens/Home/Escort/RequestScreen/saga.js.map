{"version":3,"names":["api","setIncidentEscortData","removeScreenAction","Screens","IncidentAction","IncidentEscortState","moment","call","cancel","fork","put","select","take","takeLatest","getCachedFineGeoPoint","startBackgroundGeolocationToEscort","NavigatorService","isAndroid","makeSelectSelectedOrganization","addPendingEscort","cancelEscortFailure","cancelEscortSuccess","hideCancelEscortModal","startEscortFailure","startEscortSuccess","CANCEL_ESCORT_REQUEST","CANCEL_ESCORT_SUCCESS","START_ESCORT_REQUEST","makeSelectPendingEscort","NativeModules","startEscortSync","action","console","log","startEscortTask","startEscort","cancelEscort","payload","selectedOrganization","geoPoint","request","location","organization","id","organizationArea","area","comment","isPanic","response","incidents","data","alertOrganization","startChat","onLocation","checkIncidentStartCompletion","error","incident","incidentActionRequest","AlertOrganization","args","doIncidentAction","start","diff","getEscort","Bluetooth","awakeLockScreen","incidentEscortData","incidentEscort","navigate","Home","Escort","Record","logger","debug","warn","Error","updateEscortState","state","Canceled","navToEscortType","EscortType","organizationNotifyScreenSaga"],"sources":["saga.ts"],"sourcesContent":["import * as api from '../../../../../api';\nimport { AxiosResponse } from 'axios';\nimport { setIncidentEscortData } from '../../../../../containers/app/actions';\nimport { removeScreenAction } from '../../../../../containers/providers/RoutesProvider/actions';\nimport Screens from '../../../../../containers/providers/RoutesProvider/screens';\nimport {\n  Id,\n  Incident,\n  IncidentAction,\n  IncidentActionRequest,\n  IncidentEscort,\n  IncidentEscortRequest,\n  IncidentEscortState,\n  Organization,\n  OrganizationWithArea,\n} from 'incident-code-core';\nimport moment from 'moment';\nimport {\n  call,\n  cancel,\n  fork,\n  put,\n  select,\n  take,\n  takeLatest,\n} from 'redux-saga/effects';\nimport { handleError } from '../../../../../utils/error';\nimport { getCachedFineGeoPoint } from '../../../../../utils/location';\nimport { startBackgroundGeolocationToEscort } from '../../../../../utils/location/backgroundGeolocation';\nimport NavigatorService from '../../../../../utils/navigation';\nimport { isAndroid } from '../../../../../utils/device';\n\nimport { makeSelectSelectedOrganization } from '../SelectOrganizationScreen/selectors';\nimport {\n  addPendingEscort,\n  cancelEscortFailure,\n  cancelEscortSuccess,\n  hideCancelEscortModal,\n  startEscortFailure,\n  startEscortSuccess,\n} from './actions';\nimport {\n  CANCEL_ESCORT_REQUEST,\n  CANCEL_ESCORT_SUCCESS,\n  START_ESCORT_REQUEST,\n} from './constants';\nimport { makeSelectPendingEscort } from './selectors';\nimport { StartEscortRequestAction } from './types';\nimport { NativeModules } from 'react-native';\n\nfunction* startEscortSync(action: StartEscortRequestAction) {\n  console.log(\"startEscortSync===>\",action)\n  const startEscortTask = yield fork(startEscort, action);\n  yield take(CANCEL_ESCORT_REQUEST);\n  yield fork(cancelEscort);\n  yield cancel(startEscortTask);\n  yield put(removeScreenAction());\n}\n\nfunction* startEscort({ payload }: StartEscortRequestAction) {\n  // make param?\n  const selectedOrganization: OrganizationWithArea = yield select(\n    makeSelectSelectedOrganization(),\n  );\n  try {\n    const geoPoint = yield call(getCachedFineGeoPoint);\n    const request: IncidentEscortRequest = {\n      location: geoPoint,\n      organization: selectedOrganization.id,\n      organizationArea: selectedOrganization.area as Id,\n      comment: payload.comment,\n      isPanic: payload.isPanic,\n    };\n    const response: AxiosResponse<Incident> = yield call(\n      api.incidents.startEscort,\n      request,\n    );\n    yield put(addPendingEscort(response.data));\n    yield call(alertOrganization, response.data, selectedOrganization);\n    yield call(startChat, response.data, selectedOrganization);\n    console.log(\"================================Request screen saga startBackgroundGeolocationToEscort================================\")\n    yield call(\n      startBackgroundGeolocationToEscort,\n      response.data.id,\n      payload.onLocation,\n    );\n\n    yield call(\n      checkIncidentStartCompletion,\n      response.data,\n      selectedOrganization,\n    );\n  } catch (error) {\n    yield put(startEscortFailure(error as Error));\n  }\n}\n\nfunction* alertOrganization(\n  incident: Incident,\n  organization: OrganizationWithArea,\n) {\n  const incidentActionRequest: IncidentActionRequest = {\n    id: incident.id as Id,\n    action: IncidentAction.AlertOrganization,\n    args: {\n      organization: organization.id as Id,\n      organizationArea: organization.area as Id,\n    },\n  };\n  yield call(api.incidents.doIncidentAction, incidentActionRequest);\n}\n\nfunction* startChat(incident: Incident, organization: Organization) {\n  const location = yield call(getCachedFineGeoPoint);\n  yield call(api.incidents.startChat, {\n    incident: incident.id as Id,\n    organization: organization.id as Id,\n    location,\n  });\n}\n\nfunction* checkIncidentStartCompletion(\n  incident: Incident,\n  organization: Organization,\n) {\n  const start = moment();\n\n  while (moment().diff(start, 'minutes') <= 5) {\n    try {\n      const response: AxiosResponse<IncidentEscort> = yield call(\n        api.incidents.getEscort,\n        incident.id as Id,\n      );\n      // if (response.data.state === IncidentEscortState.Active) {\n      if (isAndroid) {\n        NativeModules.Bluetooth.awakeLockScreen();\n      }\n\n      const incidentEscortData = {\n        incidentEscort: response.data,\n        organization,\n      };\n      yield put(setIncidentEscortData(incidentEscortData));\n      yield call(\n        NavigatorService.navigate,\n        Screens.Home.Escort.Record,\n        incidentEscortData,\n      );\n      yield put(startEscortSuccess());\n      yield put(hideCancelEscortModal());\n      yield put(removeScreenAction());\n      api.logger.debug('Request screen CheckVideoUpload', 'Success', response.data);\n      return;\n      // }\n    } catch (error) {\n      api.logger.warn('Request screen CheckVideoUpload', 'Failed', error);\n    }\n    // finally {\n    //   yield delay(5000);\n    // }\n  }\n  yield put(hideCancelEscortModal());\n  yield put(removeScreenAction());\n  yield put(\n    startEscortFailure(\n      new Error(\n        'WeÂ´re sorry, no security personnel are available now. Please either select a different organization or try again later.',\n      ),\n    ),\n  );\n}\n\nfunction* cancelEscort() {\n  console.log(\"Cancel Escort\")\n  try {\n    const incident: Incident = yield select(makeSelectPendingEscort());\n    yield call(api.incidents.updateEscortState, incident.id, {\n      state: IncidentEscortState.Canceled,\n    });\n    yield put(cancelEscortSuccess());\n  } catch (error) {\n    yield put(cancelEscortFailure(error as Error));\n  }\n}\n\nfunction* navToEscortType() {\n  yield call(NavigatorService.navigate, Screens.Home.Escort.EscortType);\n}\n\nexport default function* organizationNotifyScreenSaga() {\n  yield takeLatest(START_ESCORT_REQUEST, startEscortSync);\n  yield takeLatest(CANCEL_ESCORT_SUCCESS, navToEscortType);\n}\n"],"mappings":"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","ignoreList":[]}